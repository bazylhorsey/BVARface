<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="BVAR Face" name="title">
    <meta content="A beaver face augmentation app over web stream" name="description">
    <style>
      #videoElement {
        display: none;
      }

      #canvasElement {
        display: none;
      }

      #imageElement {
        height: 480px;
        width: 640px;
      }

    </style>
  </head>
  <body>
      <div id="container">
        <video autoplay="true" id="videoElement"></video>
        <img id="imageElement" src="{{ url_for('video_feed') }}">
        <canvas id="canvasElement"></canvas>
      </div>
      <script>
        $(document).ready(function() {
          let namespace = "/test";
          let video = document.querySelector("#videoElement");
          let canvas = document.querySelector("#canvasElement");
          let ctx = canvas.getContext("2d");
          var local_video = null;
          var socket = io.connect(location.protocol + "//" + document.domain + ":" + location.port + namespace);

          socket.on("connect", function() {
            console.log("Connected");
          });

          function send() {
            if (!local_video) return;

            ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight, 0, 0, 300, 150);
            let data = canvas.toDataURL("image/jpeg");
            socket.emit("data", data);
          }

          var media = {video: { width: {min: 640}, height: {min: 480} } };
          navigator.mediaDevices.getUserMedia(media).then(function(update) {
            video.srcObject = media;
            local_video = media;

            setInterval(function() {
              send();
              }, 50);
            }).catch(function(e) { console.log(e); });
        });
      </script>
      <script src="https://code.jquery.com/jquery-3.5.0.slim.min.js" integrity="sha256-MlusDLJIP1GRgLrOflUQtshyP0TwT/RHXsI1wWGnQhs=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
    </body>
</html>
